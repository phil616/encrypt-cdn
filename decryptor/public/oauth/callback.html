<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>OAuth 回调 - 处理中...</title>
  <style>
    * {
      box-sizing: border-box;
    }
    :root {
      color-scheme: light;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f7fb;
      color: #1f2328;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.5;
      padding: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .auth-shell {
      width: min(760px, 100%);
    }
    .card {
      background: #fff;
      border: 1px solid #eef0f3;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      padding: 28px 32px;
    }
    h2 {
      margin: 0 0 10px;
      font-size: 28px;
      font-weight: 700;
      color: #111827;
    }
    p {
      color: #4b5563;
      font-size: 15px;
      margin: 0 0 18px;
    }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 0 18px;
      height: 42px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-primary {
      background: #111;
      color: #fff;
      box-shadow: 0 10px 30px rgba(17, 17, 17, 0.15);
    }
    .btn-primary:hover {
      background: #000;
      transform: translateY(-1px);
    }
  </style>
  <script src="/oauth-config.js"></script>
  <script type="module">
    import { exchangeCodeForToken, getApplicationKey } from '../oauth.js';

    async function handleCallback() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');

        if (error) {
          throw new Error(`OAuth 错误: ${error}`);
        }

        if (!code || !state) {
          throw new Error('缺少必要的参数');
        }

        // Show loading message
        document.getElementById('status').textContent = '正在交换授权码...';

        // Exchange code for token
        const tokenResponse = await exchangeCodeForToken(code, state);
        console.log('Token obtained:', tokenResponse);

        // Show progress
        document.getElementById('status').textContent = '正在获取解密密钥...';

        // Get application key
        const appKey = await getApplicationKey();
        console.log('Application key obtained');

        // Store key in cookie
        document.cookie = `dec_key=${appKey};path=/;SameSite=Lax;max-age=${30 * 24 * 60 * 60}`;

        // Show success
        document.getElementById('status').textContent = '登录成功！正在跳转...';

        // Get redirect path from auth state
        const authStateStr = sessionStorage.getItem('auth_state');
        let redirectPath = '/';
        if (authStateStr) {
          const authState = JSON.parse(authStateStr);
          redirectPath = authState.preAuthPath || '/';
          sessionStorage.removeItem('auth_state');
        }

        // Redirect back to original page with success marker
        const redirectUrl = redirectPath + (redirectPath.includes('?') ? '&' : '?') + 'oauth_success=1';
        setTimeout(() => {
          console.log('Redirecting to:', redirectUrl);
          window.location.href = redirectUrl;
        }, 1000);

      } catch (error) {
        console.error('OAuth callback error:', error);
        document.getElementById('status').textContent = `处理失败: ${error.message}`;
        document.getElementById('status').style.color = '#d32f2f';

        // Show retry button
        document.getElementById('retry-btn').style.display = 'block';
      }
    }

    function retry() {
      window.location.href = '/';
    }

    // Start handling callback
    handleCallback();

    // Make retry function global
    window.retryOAuth = retry;
  </script>
</head>
<body>
  <div class="auth-shell">
    <div class="card">
      <h2>OAuth 登录处理中</h2>
      <p id="status">正在验证授权码...</p>
      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
        <button
          id="retry-btn"
          onclick="window.retryOAuth()"
          class="btn btn-primary"
          style="display: none;"
        >
          返回重试
        </button>
      </div>
    </div>
  </div>
</body>
</html>
